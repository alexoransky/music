Project music
=============

The objective is to explore various music scales and intervals using
MIDI synthesizers and CLI or GUI visualizations.

Here is a list of Python tools for music:
https://wiki.python.org/moin/PythonInMusic

The project works with SimpleSynth or FluidSynth (preferred).
Both synths work with Sound Font SF2 instrument sample files.
Polyphone tool can be used to edit files:
https://www.polyphone-soundfonts.com/download

Basically, the music theory part that is needed is described in wikipedia: 

https://en.wikipedia.org/wiki/Semitone#Minor_second
https://en.wikipedia.org/wiki/Just_intonation
https://en.wikipedia.org/wiki/Interval_(music)
https://en.wikipedia.org/wiki/Diatonic_scale
https://en.wikipedia.org/wiki/Scale_(music)
https://en.wikipedia.org/wiki/Minor_scale#Melodic_minor_scale
https://en.wikipedia.org/wiki/Chromatic_scale
https://en.wikipedia.org/wiki/Heptatonic_scale
https://en.wikipedia.org/wiki/MIDI
https://en.wikipedia.org/wiki/Scientific_pitch_notation
https://en.wikipedia.org/wiki/Chord_(music)

FluidSynth
----------
FluidSynth is used to generate sound on both macOS and Linux.
http://www.fluidsynth.org
APIs:
http://www.fluidsynth.org/api/index.html

Lilypond
--------
Lilypond is the software that allows to store music in text-based files instead of sheets.
http://lilypond.org
Frescobaldi is GUI for the Lilypond:
https://www.frescobaldi.org


04/15/2020
----------
Project created
Added notes, diatonic intervals.

04/18/2020
----------
Added heptatonic scales, 12-TET.
The project will be using PyGame to play MIDI.
https://www.pygame.org/news
Installed SympleSynth to check MIDI output. The sound is not great. Need to install something better.

04/25/2020
----------
Will try FluidSynth with sound fonts:
https://sites.google.com/site/soundfonts4u/
FluidSynth will be CLI only, installed with homebrew.
homebrew install fluid-synth
It turns out that PyFluidSynth only supports FS 1.11.1, so this one has to be installed instead:
brew install https://raw.githubusercontent.com/Homebrew/homebrew-core/34dcd1ff65a56c3191fa57d3dd23e7fffd55fae8/Formula/fluid-synth.rb

The instruments will be NiceKeys B JN 1.4 (full keys with small piano).
Bunch of sound fonts are here:
https://sites.google.com/site/soundfonts4u/

Initialize fluidsynth with a small sound font to use the CLI.  This is not needed for python program.
fluidsynth -o midi.driver=coremidi -o audio.driver=coreaudio -o audio.coreaudio.device=default -o audio.period-size=256 /Users/alex/PycharmProject/music/data/Nice-Keys-B-Plus-JN1.4.sf2

We will be using PyFLuidSynth for a Python API wrapper.
https://github.com/nwhitehead/pyfluidsynth
It turns that it is for Python 2, so I patched it. Copy the patches/fluidsynthpath.py to where it is installed:
/Library/Frameworks/Python.framework/Versions/3.8/lib/python3.8/site-packages/fluidsynth.py

Install osascript
This is needed to control output volume in macOS. FS outputs some noise when the destructor is called.

FluidSynth settings is a great reference on how to control the synth.
http://www.fluidsynth.org/api/fluidsettings.xml#synth.gain

All that is incorporated with examples in the Synth class.

Added chords.

04/26/2020
----------
Explored Polyphone.  I really needed just a tool that would list presets in the SF2 file.
Updated chord print names.
Added Sus2 and Sus4 chords.

For GUI- installed Qt 5.12.8.  PySide2 seems to support only 5.12 as of now.

05/01/2020
----------
Added octave numbers to note names.
Reworked note names.
Added chord inversions.

05/02/2020
----------
Added .gitignore.

There is a project that draws a piano keyboard in the terminal:
https://github.com/s-d-m/pianoterm/blob/master/src/music_player.cc
Which is based on termbox library to draw anything in the terminal:
https://github.com/nsf/termbox

Interesting intro into WebMIDI:
https://www.smashingmagazine.com/2018/03/web-midi-api/

05/08/2020
----------
Arturia KeyStep 32 has arrived.  Works great with GarageBand.
FluidSynth requires a tool to bridge the controller's output MIDI port to its input port.
Found a MIDI router to map those:
https://github.com/icaroferre/MIDIRouter
Apparently it is Python Qt app, so it is great. Will be able to re-use parts.

Another MIDI route, called MIDI patchbay is not compatible with MacOS Catalina, is an Xcode project
and the has been in works for 6 months by now.

05/09/2020
----------
Added a MIDI router that uses mido lib to map the ports.
The router forwards MIDI messages from the designated input port to tbe designated output port.
It also queues all MIDI messages that are generated by the keyboard so that another thread
an access them.

05/10/2020
----------
Added a MIDI parser to print notes and chords that are being played.

05/18/2020
----------
Added the project on github.
Started porting to Linux. Fluidsynth 2.1.2 is installed on Arch.  
Fluidsynth 2.1.2 has updated APIs: http://www.fluidsynth.org/api/
I had to patch the fluidsynth.py to support those.  This is not complete bindings but works for this project.

05/19/2020
----------
Removed the code to reduce the volume in macOS when FLuidSynth is stopping.
Added a delay of 1 second instead.

05/20/2020
----------
Need to investigate how to create a PyQt tabbed app without the Qt GUI builder.
Added a simple GUI app with tabs.  

05/21/2020
----------
The GUI app is moved to midi project.

05/22/2020
----------
Added support for FLuid Synth to the GUI app.
Added a simple MIDI router to the GUI app.

05/25/2020
----------
LilyPond is program to convert text based muisic score file to sheet music.
It provides a de-facto standard file format (.ly) thaqt allows for specifying complex music pieces.
My idea is to use .ly files to play music using FluidSynth.
I will have to convert my scietific pitch notation (c#3) to Helmholz-like pitch notation (cis') 
in order to use those files.

Lilypond generates a MIDI file, so that can be used to play the music. 
There is python-ly project to read the music from .ly files into Python data structures.

05/26/2020
----------
Added a simple MIDI file player that is based on mido library.

05/30/2020
----------
Finished rework of the simple MIDI player- added a thread for playback, ability to pause/release
the playback, jump to the message or time mark.
Still need to add a synth channel-MIDI port-file track map.
As of now, it does not work type 2 (asynchronous) MIDI files.
I started working on the multi-thread player but that pause/release breaks synchronization
between threads even for type 1 files.

05/31/2020
----------
Today, I have added an ability add play a fragment of the file (from any note to any note) 
to the MIDIFilePlayer.

06/03/2020
----------
Reworked the player to use a simple state machine.

06/06/2020
----------
Started working on a metronome function.  The metronome click and bell sounds are MIDI notes 33 and 34 and
defined are in General MIDI Level 2:
https://soundprogramming.net/file-formats/general-midi-drum-note-numbers/
It turns out that not many sound fonts actually have those. They are in this sound font made by Rick Simon, 
in bank 128, preset 0 (127:000) but (128:004) seems to sound better.
Note that 128:056 with notes 45 and 46 sounds even better. 
https://musescore.org/en/node/109371

In order to explore and edit sound fonts, I installed Polyphone tool:
https://www.polyphone-soundfonts.com

06/12/2020
----------
After updating alsa-lib to 1.2.3-1, FLuidSynth generates an error:
ALSA lib dlmisc.c:338:(snd_dlobj_cache_get0) Cannot open shared library libasound_module_pcm_pulse.so (libasound_module_pcm_pulse.so: libasound_module_pcm_pulse.so: cannot open shared object file: No such file or directory)
fluidsynth: error: Failed to open the "default" audio device

Reverted to alsa-lib 1.2.2-1:
sudo pacman -U https://archive.archlinux.org/packages/a/alsa-lib/alsa-lib-1.2.2-1-x86_64.pkg.tar.zst
And also changed /etc/pacman.conf to ignore alsa-lib updates
IgnorePkg   = alsa-lib

Old versions can be found in:
https://archive.archlinux.org/packages/a/alsa-lib/

06/13/2020
----------
Finished the metronome class. I had to change the synth and the router class a little.
